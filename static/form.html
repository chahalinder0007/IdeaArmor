<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link href="./css/form.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script type="text/javascript">
      function onFocus() {
        let validationElement = document.getElementById("validationMessage");
        validationElement.style.display = "none";
      }
      function openPopup() {
        let validationElement = document.getElementById("subsWrapper");
        validationElement.style.display = "flex";
      }
      function closePopup() {
        let validationElement = document.getElementById("subsWrapper");
        validationElement.style.display = "none";
      }
    </script>
  </head>
  <body>
    <section class="topHeader">
      <div class="topBar">
        <a href="/"><img src="./images/logo-redis-3.svg" /></a>
      </div>
    </section>
    <section class="wrapper">
      <div class="formWrapper">
        <form id="marketForm">
          <div class="formRow">
            <div class="formItem">
              <label>Projection Starting Year (20XX)</label>
              <input
                id="projectionYear"
                onfocus="onFocus()"
                type="number"
                required
              />
            </div>
            <div class="formItem">
              <label>Global Sales (In $5,000,000,000)</label>
              <input
                id="globalSales"
                onfocus="onFocus()"
                type="number"
                step="0.01"
                required
              />
            </div>
            <div class="formItem">
              <label>Compound Annual Growth Rate (in %)</label>
              <input
                id="cagr"
                onfocus="onFocus()"
                type="number"
                max="99"
                required
              />
            </div>
          </div>
          <div class="formRow">
            <div class="formItem">
              <label>Target Market Share (in %)</label>
              <input
                id="targetMarketShare"
                onfocus="onFocus()"
                type="number"
                max="99"
                required
              />
            </div>
            <div class="formItem">
              <label>Expected Royalty Rate (in %)</label>
              <input
                id="royalty"
                onfocus="onFocus()"
                type="number"
                max="99"
                required
              />
            </div>
            <div class="formItem">
              <label>Risk Adjusted Discount Rate (in %)</label>
              <input
                id="discountRate"
                onfocus="onFocus()"
                type="number"
                max="99"
                required
              />
            </div>
            <div id="validationMessage">Please fill required fields.</div>
          </div>

          <button class="formButton" type="submit">Submit</button>
        </form>
      </div>
    </section>
    <script type="text/javascript">
      let myChart;
      let canvasElement = document.getElementById("chartSection");
      canvasElement.style.display = "none";
      document
        .getElementById("marketForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          if (myChart) {
            myChart.destroy();
            canvasElement.style.display = "none";
          }
          let validationElement = document.getElementById("validationMessage");
          let projectionYear = parseFloat(
            document.getElementById("projectionYear").value
          );
          let globalSales = parseFloat(
            document.getElementById("globalSales").value
          );
          let cagr = parseFloat(document.getElementById("cagr").value);
          let targetMarketShare = parseFloat(
            document.getElementById("targetMarketShare").value
          );
          let royalty = parseFloat(document.getElementById("royalty").value);
          let discountRate = parseFloat(
            document.getElementById("discountRate").value
          );
          let chartLabels = [];
          let chartData = [];
          let totalValue = 0;
          if (
            projectionYear &&
            globalSales &&
            cagr &&
            targetMarketShare &&
            royalty &&
            discountRate
          ) {
            validationElement.style.display = "none";
            let result = [];
            for (let i = 0; i < 10; i++) {
              let pgs =
                i != 0 ? result[i - 1].potentialGlobalSales : globalSales;
              if (i != 0) {
                projectionYear = projectionYear + 1;
                let percentageOfGlobalSale = (pgs * cagr) / 100;
                pgs = percentageOfGlobalSale + pgs;
              }
              chartLabels.push(projectionYear);
              let psop = (pgs * targetMarketShare) / 100;
              let re = (psop * royalty) / 100;
              re = parseFloat(re.toFixed(2));
              let incrementedDiscountRate = discountRate / 100;
              let incrementedIndex = i + 1;
              let drf =
                1 / Math.pow(incrementedDiscountRate + 1, incrementedIndex);
              drf = parseFloat(drf.toFixed(2));
              result.push({
                year: projectionYear,
                potentialGlobalSales: parseFloat(pgs.toFixed(2)),
                potentialSalesOfProduct: parseFloat(psop.toFixed(2)),
                royaltyEarning: re,
                discountRateFactor: drf,
                presentIpValue: parseFloat((re * drf).toFixed(2)),
              });
              chartData.push(parseFloat((re * drf).toFixed(2)));
              totalValue = totalValue + parseFloat((re * drf).toFixed(2));
            }
            console.log(totalValue);
            console.log(result);
          } else {
            validationElement.style.display = "block";
          }
          canvasElement.style.display = "block";
          if (chartData) {
            const totalValueElement =
              document.getElementById("totalValueElement");
            totalValueElement.innerHTML = `Total Value: ${totalValue}`;
            const ctx = document.getElementById("myChart").getContext("2d");
            myChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: chartLabels,
                datasets: [
                  {
                    label: "",
                    data: chartData,
                    backgroundColor: [
                      "rgba(255, 99, 132, 0.2)",
                      "rgba(54, 162, 235, 0.2)",
                      "rgba(255, 206, 86, 0.2)",
                      "rgba(75, 192, 192, 0.2)",
                      "rgba(153, 102, 255, 0.2)",
                      "rgba(255, 159, 64, 0.2)",
                      "rgba(255, 140, 132, 0.2)",
                      "rgba(255, 99, 235, 0.2)",
                      "rgba(255, 68, 86, 0.2)",
                      "rgba(75, 186, 186, 0.2)",
                    ],
                    borderColor: [
                      "rgba(255, 99, 132, 1)",
                      "rgba(54, 162, 235, 1)",
                      "rgba(255, 206, 86, 1)",
                      "rgba(75, 192, 192, 1)",
                      "rgba(153, 102, 255, 1)",
                      "rgba(255, 159, 64, 1)",
                      "rgba(255, 140, 132, 1)",
                      "rgba(255, 99, 235, 1)",
                      "rgba(255, 68, 86, 1)",
                      "rgba(75, 186, 186, 1)",
                    ],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                  },
                },
                plugins: {
                  datalabels: {
                    anchor: "end",
                    align: "top",
                    formatter: (value) => value,
                    color: "black",
                    font: {
                      weight: "bold",
                    },
                  },
                },
              },
              legend: {
                display: false, // This hides the legend entirely
              },
              plugins: [ChartDataLabels],
            });
          }
        });
      document
        .getElementById("subsForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          console.log("enter");
        });
    </script>
  </body>
</html>